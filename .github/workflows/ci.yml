name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  ZENOH_VERSION: "1.0.0"

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libopencv-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Zenoh-C
        id: cache-zenohc
        uses: actions/cache@v4
        with:
          path: /usr/local/lib/libzenohc*
          key: zenohc-linux-${{ env.ZENOH_VERSION }}

      - name: Build and install Zenoh-C
        if: steps.cache-zenohc.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch ${{ env.ZENOH_VERSION }} \
            https://github.com/eclipse-zenoh/zenoh-c.git /tmp/zenoh-c || \
          git clone --depth 1 https://github.com/eclipse-zenoh/zenoh-c.git /tmp/zenoh-c
          cd /tmp/zenoh-c
          mkdir build && cd build
          cmake .. -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
          ninja
          sudo ninja install
          sudo ldconfig

      - name: Configure
        run: cmake --preset linux-release

      - name: Build
        run: cmake --build --preset linux-release

      - name: Test
        run: ctest --preset linux-release --output-on-failure

  build-macos:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          brew update
          brew install cmake ninja opencv pkg-config

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Zenoh-C
        id: cache-zenohc
        uses: actions/cache@v4
        with:
          path: /usr/local/lib/libzenohc*
          key: zenohc-macos-${{ env.ZENOH_VERSION }}

      - name: Build and install Zenoh-C
        if: steps.cache-zenohc.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch ${{ env.ZENOH_VERSION }} \
            https://github.com/eclipse-zenoh/zenoh-c.git /tmp/zenoh-c || \
          git clone --depth 1 https://github.com/eclipse-zenoh/zenoh-c.git /tmp/zenoh-c
          cd /tmp/zenoh-c
          mkdir build && cd build
          cmake .. -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
          ninja
          sudo ninja install

      - name: Configure
        run: cmake --preset macos-release

      - name: Build
        run: cmake --build --preset macos-release

      - name: Test
        run: ctest --preset macos-release --output-on-failure

  build-windows:
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ninja
        run: choco install ninja -y

      - name: Install OpenCV
        run: |
          $opencvVersion = "4.9.0"
          $opencvUrl = "https://github.com/opencv/opencv/releases/download/$opencvVersion/opencv-$opencvVersion-windows.exe"
          Invoke-WebRequest -Uri $opencvUrl -OutFile opencv-installer.exe
          Start-Process -FilePath .\opencv-installer.exe -ArgumentList "-oC:\ -y" -Wait -NoNewWindow
          echo "OpenCV_DIR=C:\opencv\build\x64\vc16\lib" >> $env:GITHUB_ENV
          echo "C:\opencv\build\x64\vc16\bin" >> $env:GITHUB_PATH

      - name: Cache Zenoh-C
        id: cache-zenohc
        uses: actions/cache@v4
        with:
          path: C:\zenohc
          key: zenohc-windows-prebuilt-${{ env.ZENOH_VERSION }}

      - name: Download pre-built Zenoh-C
        if: steps.cache-zenohc.outputs.cache-hit != 'true'
        run: |
          # Download pre-built MSVC binary from Eclipse Foundation
          $zenohUrl = "https://download.eclipse.org/zenoh/zenoh-c/${{ env.ZENOH_VERSION }}/zenoh-c-${{ env.ZENOH_VERSION }}-x86_64-pc-windows-msvc.zip"
          Write-Host "Downloading Zenoh-C from: $zenohUrl"
          Invoke-WebRequest -Uri $zenohUrl -OutFile zenoh-c.zip

          # Extract to C:\zenohc
          Expand-Archive -Path zenoh-c.zip -DestinationPath C:\zenohc-temp -Force

          # Move contents up one level (archive contains zenoh-c-VERSION-xxx folder)
          $extractedDir = Get-ChildItem -Path C:\zenohc-temp -Directory | Select-Object -First 1
          Move-Item -Path "$($extractedDir.FullName)\*" -Destination C:\zenohc-temp -Force -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Path C:\zenohc -Force
          Move-Item -Path C:\zenohc-temp\* -Destination C:\zenohc -Force
          Remove-Item -Path C:\zenohc-temp -Recurse -Force -ErrorAction SilentlyContinue

          # List installed files for debugging
          Write-Host "Zenoh-C installed to C:\zenohc:"
          Get-ChildItem -Path C:\zenohc -Recurse | Select-Object FullName

      - name: Add Zenoh to PATH
        run: echo "C:\zenohc\bin" >> $env:GITHUB_PATH

      - name: Configure
        run: |
          cmake --preset windows-release `
            -DOpenCV_DIR=${{ env.OpenCV_DIR }} `
            -DCMAKE_PREFIX_PATH=C:\zenohc

      - name: Build
        run: cmake --build --preset windows-release

      - name: Test
        shell: pwsh
        run: |
          $env:Path = "C:\zenohc\bin;C:\opencv\build\x64\vc16\bin;$env:Path"
          ctest --preset windows-release --output-on-failure
